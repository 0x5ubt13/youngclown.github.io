<!DOCTYPE html><html lang="lang"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Client IP 문제(X-Forwarded-For) 해결 방안"><meta name="keywords" content><meta name="author" content="bymin"><meta name="copyright" content="bymin"><title>Client IP 문제(X-Forwarded-For) 해결 방안 | 젊은광대 기술블로그</title><link rel="shortcut icon" href="../../../melody-favicon.ico"><link rel="stylesheet" href="../../../css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Getting-The-Real-IP-Of-Your-Users"><span class="toc-number">1.</span> <span class="toc-text">Getting The Real IP Of Your Users</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C"><span class="toc-number">2.</span> <span class="toc-text">C#</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C-1"><span class="toc-number">3.</span> <span class="toc-text">C#</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP"><span class="toc-number">4.</span> <span class="toc-text">PHP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-and-JSP"><span class="toc-number">5.</span> <span class="toc-text">Java and JSP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ASP-VBScript"><span class="toc-number">6.</span> <span class="toc-text">ASP/VBScript</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ColdFusion"><span class="toc-number">7.</span> <span class="toc-text">ColdFusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Perl"><span class="toc-number">8.</span> <span class="toc-text">Perl</span></a></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#참조"><span class="toc-number"></span> <span class="toc-text">참조</span></a></li></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="../../../img/avatar.png"></div><div class="author-info__name text-center">bymin</div><div class="author-info__description text-center">잘정리하자</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="../../../archives"><span class="pull-left">Articles</span><span class="pull-right">109</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../../index.html">젊은광대 기술블로그</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Client IP 문제(X-Forwarded-For) 해결 방안</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2010-12-06</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>L4 에서 IP를 바꿔버리는 문제가 발생했습니다.<br>스위치를 예전 모델로 교체한다고 하여도 해당문제는 앞 단에 위치하게 되는 Firewall 장비에서 IP Remapping 할 가능성이 존재한다는 답변을 들었습니다.<br>L4 에서는 IP 를 Remapping 하면서 Client IP 를 아예 없애버리는 게 아니고 X-Forwarded-For 라는 헤더에 남겨 놓는다고 하여 해당 값을 가져다 쓰라고 하였습니다.<br>(대부분의 Proxy에서 이런 방법으로 IP를 기록한다고 합니다.)</p>
<p>기본적으로는 X-Forwarded-For 정보를 헤더에서 추출하고 그 값이 비어있을 경우 Remote-Addr 헤더로 문제없이 사용이 가능합니다.</p>
<p>참고로 해당 값은 LP VIP 을 통해 들어갈 때만 생기며, 클라이언트에서 보내주는 헤더값이 아니라 L4 VIP 를 통해 들어갈때 L4에서 헤더에 넣어주는 헤더값을 의미합니다.</p>
<p>자바내의 처리로직 :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HttpServletRequest request</span><br><span class="line"></span><br><span class="line">String ip = request.getHeader(&quot;HTTP_X_FORWARDED_FOR&quot;);</span><br><span class="line"></span><br><span class="line">if(ip == null || ip.length() == 0 || ip.toLowerCase().equals(&quot;unknown&quot;))</span><br><span class="line">    ip = request.getHeader(&quot;REMOTE_ADDR&quot;);</span><br><span class="line"></span><br><span class="line">if(ip == null || ip.length() == 0 || ip.toLowerCase().equals(&quot;unknown&quot;))</span><br><span class="line">    ip = request.getRemoteAddr();</span><br></pre></td></tr></table></figure></p>
<p>아래는 해외 문서를 참고한 내용입니다.</p>
<h2 id="Getting-The-Real-IP-Of-Your-Users"><a href="#Getting-The-Real-IP-Of-Your-Users" class="headerlink" title="Getting The Real IP Of Your Users"></a>Getting The Real IP Of Your Users</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">There are a lot of sites around the internet that try and get your IP address. Most of their reasons are legitimate. For example Google Adsense will log your IP to see where the user clicking the advert is from (and kick you off if its the same IP you logged into that account with).</span><br><span class="line"></span><br><span class="line">However, there are some sites that try to look at your IP for various reasons but do it wrong. Rapidshare is a beatifully painful example of this. If you’re on an ISP that uses a transparent proxy, RapidShare will log the proxy address instead of the actual account IP. As they limit the downloading on a per-IP basis, that means everyone using that ISP, going through that proxy, has the same IP to Rapidshare, meaning the limit to how much you download is split among those users.</span><br><span class="line"></span><br><span class="line">What I’m saying here is, if you’re going to do your own IP lookups for whatever reason, do them correctly. My initial code here was in VB.net but since I have translated what its doing to the most popular server-side languages. As its based on the server variables, rather than the code’s process, its quite easy to port to something else if you need to.</span><br><span class="line"></span><br><span class="line">The lookup that these “incorrect” sites are doing is something like this:</span><br><span class="line"></span><br><span class="line">Request.ServerVariables(&quot;REMOTE_ADDR&quot;)</span><br><span class="line">What then need to be doing is comparing the HTTP_X_FORWARDED_FOR variable against it, to check that there isn’t a non-transparent proxy in the way. Like so:</span><br><span class="line"></span><br><span class="line">&apos; Look for a proxy address firstDim _ip As String = Request.ServerVariables(&quot;HTTP_X_FORWARDED_FOR&quot;)&apos; If there is no proxy, get the standard remote addressIf (_ip = &quot;&quot; Or _ip.ToLower = &quot;unknown&quot;) Then _ _ip = Request.ServerVariables(&quot;REMOTE_ADDR&quot;)</span><br><span class="line">This doesnt help people that are limited to (or otherwise) on anonymous proxies. They will hide the forwarding address (like they’re supposed to) and therefore the lookup will ONLY get the proxy’s address. Some ISPs do this by default to “protect” their users… Its just retarded. If you ISP does this, and you’ve been wondering why RS or other sites don’t work… Now you know.</span><br><span class="line"></span><br><span class="line">If you want to check against an existing “wrong site”, try IP Chicken. It will return an incorrect value (eg the proxy). WhatsMyIP.orgis one that will look through the proxy and should give you the correct IP.</span><br><span class="line"></span><br><span class="line">Here are some more examples in other languages:</span><br></pre></td></tr></table></figure>
<h2 id="C"><a href="#C" class="headerlink" title="C#"></a>C#</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Look for a proxy address firstString</span><br><span class="line">_ip = Request.ServerVariables[&quot;HTTP_X_FORWARDED_FOR&quot;];</span><br><span class="line">// If there is no proxy, get the standard remote address</span><br><span class="line">If (_ip == &quot;&quot; || _ip.ToLower == &quot;unknown&quot;)</span><br><span class="line">_ip = Request.ServerVariables[&quot;REMOTE_ADDR&quot;];</span><br></pre></td></tr></table></figure>
<h2 id="C-1"><a href="#C-1" class="headerlink" title="C#"></a>C#</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Look for a proxy address firstString</span><br><span class="line">_ip = Request.ServerVariables[&quot;HTTP_X_FORWARDED_FOR&quot;];</span><br><span class="line">// If there is no proxy, get the standard remote address</span><br><span class="line">If (_ip == &quot;&quot; || _ip.ToLower == &quot;unknown&quot;)</span><br><span class="line">_ip = Request.ServerVariables[&quot;REMOTE_ADDR&quot;];</span><br></pre></td></tr></table></figure>
<h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><p>Based on code from OxyScripts.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function GetUserIP() &#123;</span><br><span class="line">if (isset($_SERVER)) &#123;</span><br><span class="line">if (isset($_SERVER[&quot;HTTP_X_FORWARDED_FOR&quot;]))</span><br><span class="line">return $_SERVER[&quot;HTTP_X_FORWARDED_FOR&quot;];</span><br><span class="line">if (isset($_SERVER[&quot;HTTP_CLIENT_IP&quot;]))</span><br><span class="line">return $_SERVER[&quot;HTTP_CLIENT_IP&quot;];</span><br><span class="line">return $_SERVER[&quot;REMOTE_ADDR&quot;]; &#125;</span><br><span class="line">if (getenv(&apos;HTTP_X_FORWARDED_FOR&apos;))</span><br><span class="line">return getenv(&apos;HTTP_X_FORWARDED_FOR&apos;);</span><br><span class="line">if (getenv(&apos;HTTP_CLIENT_IP&apos;))</span><br><span class="line">return getenv(&apos;HTTP_CLIENT_IP&apos;);</span><br><span class="line">return getenv(&apos;REMOTE_ADDR&apos;);&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Java-and-JSP"><a href="#Java-and-JSP" class="headerlink" title="Java and JSP"></a>Java and JSP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String ipaddress = request.getHeader(&quot;HTTP_X_FORWARDED_FOR&quot;);</span><br><span class="line">if (ipaddress == null)</span><br><span class="line">ipaddress = request.getRemoteAddr();</span><br></pre></td></tr></table></figure>
<h2 id="ASP-VBScript"><a href="#ASP-VBScript" class="headerlink" title="ASP/VBScript"></a>ASP/VBScript</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipaddress = Request.ServerVariables(&quot;HTTP_X_FORWARDED_FOR&quot;)</span><br><span class="line">if ipaddress = &quot;&quot;</span><br><span class="line">then</span><br><span class="line">ipaddress = Request.ServerVariables(&quot;REMOTE_ADDR&quot;</span><br><span class="line">)end if</span><br></pre></td></tr></table></figure>
<h2 id="ColdFusion"><a href="#ColdFusion" class="headerlink" title="ColdFusion"></a>ColdFusion</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;CFCOMPONENT&gt;</span><br><span class="line">&lt;CFIF #CGI.HTTP_X_Forwarded_For# EQ &quot;&quot;&gt;</span><br><span class="line">&lt;CFSET ipaddress=&quot;#CGI.Remote_Addr#&quot;&gt;</span><br><span class="line">&lt;CFELSE&gt;</span><br><span class="line">&lt;CFSET ipaddress=&quot;#CGI.HTTP_X_Forwarded_For#&quot;&gt;</span><br><span class="line">&lt;/CFIF&gt;</span><br><span class="line">&lt;/CFCOMPONENT&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Perl"><a href="#Perl" class="headerlink" title="Perl"></a>Perl</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ip = $req-&gt;header(&apos;Client-IP&apos;) || $req-&gt;header(&apos;Remote-Addr&apos;);</span><br><span class="line">if ($req-&gt;header(&apos;X-Forwarded-For&apos;))</span><br><span class="line">&#123; $proxy = $ip; $ip = $req-&gt;header(&apos;X-Forwarded-For&apos;);&#125;</span><br></pre></td></tr></table></figure>
<p>If you know anymore, just ping them in my general direction and they can be added.</p>
<p>C# 계열은 정상 동작했는데,<br>우리쪽에서는 헤더정보를 읽어오지 못했습니다.<br>이유는 웹로직에서 포워딩할때 변경하는게 아닌가 추측됩니다.<br>모든 헤더 정보를 찍어보니 해당 헤더이름은<br>“X-Forwarded-For”(HTTP-X-FOWARDED-FOR) 로 변환해서 들어오는 것을 확인했습니다.</p>
<p> 그것은 IIS 설정에서 X-Forwarded-For 를 IP로 잡는 겁니다.<br> 인터넷에서 F5XForwardedFor 로 검색하면 상세한 정보를 알 수 있습니다.</p>
<hr>
<h1 id="참조"><a href="#참조" class="headerlink" title="참조"></a>참조</h1><hr>
<ul>
<li><a href="http://blog.chonnom.com/10100163904" rel="external nofollow noopener noreferrer" target="_blank">윈도우즈 X-Forwarded-For 아이피 변환</a></li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined" rel="external nofollow noopener noreferrer" target="_blank">bymin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://youngclown.github.io/2010/12/2010-12-06-ForwardedFor/">https://youngclown.github.io/2010/12/2010-12-06-ForwardedFor/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="../2010-12-28-crontab/"><i class="fa fa-chevron-left">  </i><span>crontab -e 로 java를 실행하기</span></a></div><div class="next-post pull-right"><a href="../2010-12-03-VI-EDITOR/"><span>vi 편집기 사용하기</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By bymin</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" rel="external nofollow noopener noreferrer" target="_blank"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" rel="external nofollow noopener noreferrer" target="_blank"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="../../../js/utils.js?version=1.6.1"></script><script src="../../../js/fancybox.js?version=1.6.1"></script><script src="../../../js/sidebar.js?version=1.6.1"></script><script src="../../../js/copy.js?version=1.6.1"></script><script src="../../../js/fireworks.js?version=1.6.1"></script><script src="../../../js/transition.js?version=1.6.1"></script><script src="../../../js/scroll.js?version=1.6.1"></script><script src="../../../js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>